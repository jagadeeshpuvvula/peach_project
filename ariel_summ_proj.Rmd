---
title: "ariel_summ_proj"
author: "Puvvula"
date: "2023-06-20"
output: pdf_document
---

```{r}
library(pacman)
pacman::p_load(tidyverse, janitor, reshape2, qgcomp)
path <- "~/Documents/PEACH_study/ariel_summ/"
```

#load and tidy variables
```{r}
dat<- read_csv(paste0(path, "ariel_exp_qn_full.csv")) |>
  select(c(2:13, 15:17, 19:22, 24:43, 142, 165, 251, 268, 291, 321, 
           starts_with("pb"), starts_with("as_urine"), starts_with("mn_blood"), starts_with("mo_urine")))|>
  rename(bdi_v1="total_score", resil_v1 = "score_overall_resilience_mean", 
         bdi_v3="total_score_v3", resil_v3="score_overall_resili_v_36") |>
  mutate(race = case_when(
    pt_race___1 == "Checked" ~ "nhsp_black",
    pt_race___2 == "Checked" ~ "white",
    pt_race___3 == "Checked" ~ "asian",
    pt_race___4 == "Checked" ~ "latino",
    pt_race___5 == "Checked" ~ "native_havi",
    pt_race___6 == "Checked" ~ "ameri_ind",
    pt_race___777 == "Checked" ~ "other",
    pt_race___888 == "Checked" ~ "unkn",
    TRUE ~ "NA" )) |>
  mutate(race = if_else(race == "white", "white", "non-white")) |>
  mutate(pt_ethni = if_else(pt_ethni == "Hispanic / Latino", "hispanic", "non-hispanic")) |>
  mutate(pt_education = if_else(pt_education == "Bachelor's degree (e.g. BA, BS)" | 
                                  pt_education == "Master's degree (e.g. MA, MS, MEd)"| 
                                  pt_education == "Doctorate (e.g. PhD, EdD)", "bach-or-abv", "lt-bach")) |>
  mutate(household_income = case_when(
    household_income == "< $20,000" ~ "lt_80k",
    household_income == "$20,000-$39,999" ~ "lt_80k",
    household_income == "$40,000-$79,999" ~ "lt_80k",
    household_income == "$80,000-$119,999" ~ "abv_80k",
    household_income == "$120,000-$159,999" ~ "abv_80k",
    household_income == ">$160,000" ~ "abv_80k",
    TRUE ~ as.factor(household_income)  # Keep other values unchanged
    ))|>
  mutate(highway = if_else(highway == "More than 1 mile" , "gt_1mile", "lt_1mile")) |>
  mutate(bmi = (prepreg_weight * 0.453592) / (((height * 30.48 + height_2 * 2.54) / 100) ^ 2))  |>
  select(-c(3:12,18,27:34)) |>
  mutate(across(c(2:16, 18, 34), as.factor)) |>
  mutate(across(-c(2:16, 18, 34), ~round(as.numeric(.), 2)))
```

#summary table
```{r}
dat_tbl<- dat |> select(-c(2:15, 18, 34))

summ<- dat_tbl |>
  pivot_longer(!c(pt_parity), names_to = "chemical", values_to = "conc")|>
  group_by(chemical) |>
  summarize(count_na = sum(is.na(conc)),
            median_conc = round(median(conc, na.rm=T),2),
            percentile_25 = round(quantile(conc, 0.25, na.rm=T),2),
            percentile_75 = round(quantile(conc, 0.75, na.rm=T),2))
```

#imputing missing data with min
```{r}
#imputing missing values with minimum values
dat_imputed<- dat |>
  mutate(across(where(is.numeric), ~replace(., is.na(.), min(., na.rm = TRUE))))  |>
  mutate(highway= as.factor(if_else(is.na(highway), "lt_1mile", highway)),
         bluespace= as.factor(if_else(is.na(bluespace), "Rarely (< 1 time per month)", bluespace)),
         sex_infant= as.factor(if_else(is.na(sex_infant), "Male", sex_infant))
         )



write_csv(dat_imputed, paste0(path, "imputed_peach.csv"))
```


#correlation coefficients 
```{r}
dat_corr<- dat_imputed |> 
  select(-c(2:16, 18, 34)) |>
  mutate_at(vars(11:17), ~log10(.+0.0000001)) |>
  rename_with(~ paste0("log_", .x), 11:17)

corr <- cor(dat_corr, method = "pearson") |>
  melt()


ggplot(corr, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_gradient2(low = "red", mid = "white", high = "blue", 
                       midpoint = 0, breaks = seq(-1, 1, 0.2)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(colour = "black", size = 8),
        strip.text.x = element_text(colour = "black", size = 6.5),
        strip.text.y = element_text(colour = "black", size = 6.5)) +
  labs(title = "", x = "", y = "") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 3)+
  guides(fill=FALSE)
```

#average levels during pregnancy vars 21-33
```{r}
dat_mod <- dat_imputed |>
  mutate(pss_avg = rowMeans(across(starts_with("pss14_")), na.rm = TRUE),
         bdi_avg = rowMeans(across(starts_with("bdi_")), na.rm = TRUE),
         resil_avg = rowMeans(across(starts_with("resil_")), na.rm = TRUE),
         pb_bld = rowMeans(across(starts_with("Pb_Blood")), na.rm = TRUE),
         mn_bld = rowMeans(across(starts_with("Mn_Blood")), na.rm = TRUE)) |>
  select(-c(21:28,31,32)) |>
  mutate(across(c(22, 23, 26:30), ~log10(.+0.0000001)))
```

#qgcomp function
```{r}
qgcomp_func<- function(outcomes, dat, folder_path, mixture) {
  for(outcome in outcomes){
    formula <- as.formula(paste(outcome, "~ pss_avg+ bdi_avg+ resil_avg+ pb_bld+ mn_bld+ Pb_Urine_V1+ As_Urine_V1+ Mo_Urine_V1+ ","age + bmi+ pt_parity+ sex_infant+ pt_education+ household_income+ race+ highway+ greenspace+ bluespace+ type_house + year_house"))
       
        nb <- qgcomp.noboot(formula, expnms = mixture, data = dat, family= gaussian(), q=4)
        boot <- qgcomp.boot(formula, expnms = mixture, data = dat, family= gaussian(), q=4, B = 200, seed = 2022)
        save(nb, file = paste0(folder_path, "/", "nb_", "_", outcome, ".rda"))
        save(boot, file = paste0(folder_path, "/", "boot_", "_", outcome, ".rda"))
  }
}
```

#get results for metal and stress scale metrics as exposure mixture
```{r}
qgcomp_func(outcomes = c("weight_infant", "length_infant", "ga_birth"), 
            mixture = names(dat_mod[c(22,23,26:30)]),
            folder_path = path, 
            dat = dat_mod)
```

#extract results from rda files
```{r}
folder_location <- path

# List files ending with ".rda" in the specified folder
file_names <- list.files(folder_location, pattern = "\\.rda$")

# create empty data frame to store the results
results <- data.frame(file = character(),
                      estimate = numeric(),
                      lower_ci = numeric(),
                      upper_ci = numeric(),
                      stringsAsFactors = FALSE)

#loops through all .rda files and extract estimates, CI & p-values
for (file_name in file_names) {
  # load the object from the file
  load(file.path(folder_location, file_name))
  # extract the object name using grep or grepl
  object_name <- ls()[grep("^boot|^nb", ls())]
  # extract the required information using the summary function and the object name
  estimate <- get(object_name)$coef["psi1"]
  CI <- get(object_name)$ci
  lower_ci <- CI[1]
  upper_ci <- CI[2]
  p_value <- get(object_name)$pval[2]
  # split file name by "_" and remove ".rda"
  file_parts <- strsplit(gsub("\\.rda", "", file_name), "_")[[1]]
  # assign parts to variables
  part1 <- file_parts[1]
  part2 <- file_parts[2]
  part3 <- file_parts[3]
  part4 <- file_parts[5]
  # print out the values
  cat("File:", file_name, "\n")
  cat("  Estimate:", estimate, "\n")
  cat("  Lower CI:", lower_ci, "\n")
  cat("  Upper CI:", upper_ci, "\n")
  cat("  p-value:", p_value, "\n")
  cat("  Part 1:", part1, "\n")
  cat("  Part 2:", part2, "\n")
  cat("  Part 3:", part3, "\n")
  cat("  Part 4:", part4, "\n")
  # add the results to the data frame
  results <- rbind(results, data.frame(boot_strp = part1,
                                       outcome = part3,
                                       estimate = estimate,
                                       lower_ci = lower_ci,
                                       upper_ci = upper_ci,
                                       p_value = p_value,
                                       stringsAsFactors = FALSE))
  # remove the object from the R environment to avoid conflicts with other objects (all objects saved as nb or boot)
  rm(list = object_name)
}

```



